#!/bin/sh

# --- Prompt para digitar o filme ---
search=$(dmenu -i -p "Search a movie" < /dev/null) || exit 0
[ -z "$search" ] && exit 0

# --- Formata a query para URL ---
query=$(printf "%s" "$search" | tr ' ' '+')

# --- URLs ---
site="https://www.1377x.to/srch?search=$query"
base="https://www.1337x.to/"

# --- Buscar torrents e selecionar no dmenu ---
movie=$(curl -s "$site" | grep -o 'torrent/[^"]*' | dmenu -i -l 20 -p 'Which movie?') || exit 0
[ -z "$movie" ] && exit 0

# --- Obter magnet link ---
magnetlink=$(curl -s "${base}${movie}" | grep -Po 'magnet:[^"]*' | head -n 1)
[ -z "$magnetlink" ] && exit 0

# --- Escolher ação ---
choice=$(printf "Watch\nDownload" | dmenu -i -p 'What to do?')

case "$choice" in
  Watch)
    # Assiste o filme com webtorrent e mpv
    st -e webtorrent "$magnetlink" --mpv --no-quit &
    sleep 10
    # Baixar legendas em pt-BR via subliminal
    st -e subliminal download -p opensubtitles -l pt-BR /tmp/webtorrent/ &
    ;;
  Download)
    # Adiciona para download no Transmission
    format=$(printf "%s" "$query" | tr '+' ' ')
    transmission-remote -a "$magnetlink" -w ~/
    notify-send "$format adicionado para download"
    ;;
  *)
    exit 0
    ;;
esac
